<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="Something interesting for sure...">

  <title>Nyami - Entity Builder for Unit Tests</title>

  <link rel="canonical" href="https://www.nyami.uk/posts/2020-05-04-unittestentitybuilder">

      <link type="application/rss+xml" rel="alternate" href="/feed.rss" />
      <link type="application/atom+xml" rel="alternate" href="/feed.atom" />
  
  <meta name="application-name" content="Nyami" />
  <meta name="msapplication-tooltip" content="Nyami" />
  <meta name="msapplication-starturl" content="/" />

  <meta property="og:title" content="Nyami - Entity Builder for Unit Tests" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.nyami.uk/posts/2020-05-04-unittestentitybuilder" />
  
  <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">
  <link rel="icon" href="/favicon.ico" type="image/x-icon">

  <!-- Bootstrap core CSS -->
  <link href="/vendor/bootstrap/scss/bootstrap.css" rel="stylesheet">

  <!-- Custom fonts for this template -->
  <link href="/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
  <link href="/vendor/fontawesome-free/css/brands.min.css" rel="stylesheet" type="text/css">
  <link href='https://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css' data-no-mirror>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/css' data-no-mirror>
  
  <!-- Custom styles for this template -->
  <link href="/scss/clean-blog.css" rel="stylesheet">
  
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.19.0/components/prism-core.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/prismjs@1.19.0/plugins/autoloader/prism-autoloader.min.js" data-no-mirror></script>
  <script src="https://cdn.jsdelivr.net/npm/quicklink@2.0.0/dist/quicklink.umd.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.19.0/themes/prism.css">

  <!-- Lunr search -->
  
  


  

</head>

<body>

  <!-- Navigation -->
  <nav class="navbar navbar-expand-lg navbar-light fixed-top" id="mainNav">
  <div class="container">
    <a class="navbar-brand" href="/">Nyami</a>
    <button class="navbar-toggler navbar-toggler-right" type="button" data-toggle="collapse" data-target="#navbarResponsive" aria-controls="navbarResponsive" aria-expanded="false" aria-label="Toggle navigation">
      Menu
      <i class="fas fa-bars"></i>
    </button>
    <div class="collapse navbar-collapse" id="navbarResponsive">
      <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="/posts">Posts</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/tags"></a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/tags">Tags</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/about">About Me</a>
            </li>
</ul>
    </div>
  </div>
</nav>

  <!-- Page Header -->
  <header class="masthead">
  <div class="overlay"></div>
  <div class="container">
    <div class="row">
      <div class="col-md-12">
        <div class="post-heading">
          <h1>
            Entity Builder for Unit Tests
          </h1>
              <div class="meta">Published on Monday, May 4, 2020</div>
                <div class="mt-3">
                      <a href="/tags/dotnet" class="badge badge-light"> dotnet</a>
                      <a href="/tags/tips" class="badge badge-light"> Tips</a>
                      <a href="/tags/unit-testing" class="badge badge-light"> unit testing</a>
                </div>
        </div>
      </div>
    </div>
  </div>
</header>

  <!-- Main Content -->
  <div class="container"> 
    <div class="row">
      <div id="content" class="col-md-12">  
        <p>If you find yourself needing to create an instance of a domain entity for unit testing, but having trouble getting round property or constructor accessability, using a builder is a great technique to get round this and provide a consistent, reusable method of creating the object for your tests.</p>
<!--more-->
<p>Typically you might find yourself creating opinionated constructors or getter only properties that will assert or support rules for an entity or business logic, but these can sometimes present a challenge when it comes to creating unit tests. Consider the following class:</p>
<pre><code>public class Foo
{
  public enum StatusEnum
  {
    New = 0,
    Open = 1,
    Closed = 2
  }

  // Private constructor used by Entity Framework
  private Foo() { }

  // Used to create a new Foo
  public Foo(string name)
  {
    if (string.IsNullOrWhiteSpace(name)) throw new ArgumentException(&quot;Name must not be empty&quot;, nameof(name));
    this.Name = name;
    this.Status = StatusEnum.New;
  }

  public string Name { get; private set; }
  public StatusEnum Status { get; private set; }

  public void Close() {
    if (this.Status != StatusEnum.Open) throw new Exception($&quot;{this.Name} must be open for it to be closed.&quot;);

    this.Status = StatusEnum.Closed;
  }
}
</code></pre>
<p>Here we have our Foo entity designed to assert a couple of things, firstly we can only set the name when creating the instance, and secondly we can only change the status to Closed if the status is currently Open. If we wanted to write a unit test around our <code>Close</code> method we might be tempted to change the accessability of our <code>Status</code> property, or even change the private constructor to allow us to create a usable entity in our test project, however both these actions might well lead to an API open to misuse.</p>
<p>A much better option would be to create a builder in our test project which can easily get round the constructor and property accessability and ensure some sort of consistency and reusability in our unit tests. Our builder for the class above might look a little like this:</p>
<pre><code>public class FooBuilder
{
  private readonly Type entityType = typeof(Foo);
  private readonly Foo foo;

  public FooBuilder(string name)
  {
    var entity = Activator.CreateInstance(entityType, true) as Foo;
    foo = entity ?? throw new ArgumentNullException(nameof(entity));
    entityType.GetProperty(nameof(foo.Name)).SetValue(foo, name);
  }

  public FooBuilder WithStatus(StatusEnum status)
  {
    entityType.GetProperty(nameof(foo.Status)).SetValue(foo, status);
    return this;
  }

  public Foo Build()
  {
    return foo;
  }
}
</code></pre>
<p>We can now use this builder to create and bypass our assertions without compromising the design of our entity:</p>
<pre><code>var testFoo = new FooBuilder(&quot;wibble&quot;)
  .WithStatus(StatusEnum.Open)
  .Build();
</code></pre>
<p>This is not fool proof and still open for misuse, but at least most of the damage will confined to your test projects so it's a much better option compared to 'compromising' your API design.</p>


      </div>
    </div>
  </div>

  <hr>

  <!-- Footer -->  
  <footer>
    <div class="container">
        <div class="row">
            <div class="col-md-12 text-center">
                <ul class="list-inline text-center">
                    <li class="list-inline-item">
                        <a href="https://twitter.com/nyami" class="pr-2 mr-1">
                            <span class='fa-stack fa-md'>
                                <i class='fas fa-circle fa-stack-2x'></i>
                                <i class='fab fa-twitter fa-stack-1x fa-inverse'></i>
                            </span>
                        </a>
                    </li>
                    <li class="list-inline-item">
                        <a href="https://www.linkedin.com/in/nyami/" class="pr-2 mr-1">
                            <span class='fa-stack fa-md'>
                                <i class='fas fa-circle fa-stack-2x'></i>
                                <i class='fab fa-linkedin-in fa-stack-1x fa-inverse'></i>
                            </span>
                        </a>
                    </li>
                </ul>
                <br />
                <p class="copyright text-muted m-0">Copyright &#xA9; 2022</p>
                <ul class="list-inline text-center small">
                        <li class="list-inline-item">
                            <a href="/feed.rss"><i class="fa fa-rss"></i> RSS Feed</a>
                        </li>
                        <li class="list-inline-item">
                            <a href="/feed.atom"><i class="fa fa-rss"></i> Atom Feed</a>
                        </li>
                </ul>
                <div class="font-weight-bold small"><a href="https://statiq.dev">Generated by Statiq</a></div>
            </div>
        </div>
    </div>
</footer>

  <!-- Bootstrap core JavaScript -->
  <script src="/vendor/jquery/jquery.min.js"></script>
  <script src="/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-57354598-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-57354598-1');
</script>


  

  <!-- Custom scripts for this template -->
  <script src="/js/clean-blog.js"></script>

</body>

</html>
